name: Scrape and publish data

on:
  schedule:
    # T√§glich um 02:00 Uhr UTC (03:00 MEZ / 04:00 MESZ)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Manuell ausl√∂sbar

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: florianschommers/AnstossScraper
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Compile Java Scraper
        run: |
          echo "=== KaderScraper (bundesliga.com) ==="
          javac *.java
      
      - name: Run Scraper
        run: |
          echo "Starte AktuelleTeamsScraper (aktuelle_teams_automatisch.txt)..."
          java AktuelleTeamsScraper
      
      - name: Commit and Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # Git-Konfiguration
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Setze Remote URL mit Token
          REPO_URL="https://${GITHUB_TOKEN}@github.com/florianschommers/AnstossScraper.git"
          git remote set-url origin "$REPO_URL"
          
          # WICHTIG: IMMER zuerst Pull
          echo "üîÑ Hole neueste √Ñnderungen..."
          MAX_PULL_RETRIES=10
          PULL_RETRY=0
          PULL_SUCCESS=false
          
          while [ $PULL_RETRY -lt $MAX_PULL_RETRIES ]; do
            echo "üîÑ Pull-Versuch $((PULL_RETRY + 1))/$MAX_PULL_RETRIES..."
            
            if git fetch origin main 2>&1; then
              echo "‚úÖ Fetch erfolgreich"
              
              LOCAL=$(git rev-parse HEAD)
              REMOTE=$(git rev-parse origin/main)
              
              if [ "$LOCAL" != "$REMOTE" ]; then
                echo "üì• Remote hat neue Commits..."
                
                if git rebase origin/main 2>&1; then
                  echo "‚úÖ Rebase erfolgreich"
                  PULL_SUCCESS=true
                  break
                elif git merge origin/main --no-edit 2>&1; then
                  echo "‚úÖ Merge erfolgreich"
                  PULL_SUCCESS=true
                  break
                else
                  echo "‚ö†Ô∏è Reset auf origin/main..."
                  git reset --hard origin/main 2>&1
                  PULL_SUCCESS=true
                  break
                fi
              else
                echo "‚úÖ Bereits aktuell"
                PULL_SUCCESS=true
                break
              fi
            else
              echo "‚ö†Ô∏è Fetch fehlgeschlagen"
            fi
            
            PULL_RETRY=$((PULL_RETRY + 1))
            if [ $PULL_RETRY -lt $MAX_PULL_RETRIES ]; then
              sleep $((PULL_RETRY * 2))
            fi
          done
          
          if [ "$PULL_SUCCESS" = false ]; then
            echo "‚ùå Pull fehlgeschlagen"
            exit 1
          fi
          
          # Pr√ºfe auf √Ñnderungen
          echo "üîÑ Pr√ºfe auf √Ñnderungen..."
          git status
          
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "üìù √Ñnderungen gefunden..."
            git add aktuelle_teams_automatisch.txt
            
            git commit -m "Update scraped data" || {
              echo "‚ö†Ô∏è Commit fehlgeschlagen"
              exit 0
            }
            
            # NOCHMAL Pull vor Push
            echo "üîÑ Nochmal Pull vor Push..."
            git fetch origin main 2>&1
            git rebase origin/main 2>&1 || git merge origin/main --no-edit 2>&1 || {
              echo "‚ö†Ô∏è Reset und neu committen..."
              git reset --hard origin/main 2>&1
              git add aktuelle_teams_automatisch.txt
              git commit -m "Update scraped data" 2>&1
            }
            
            # Push mit Retry
            echo "üöÄ Push..."
            MAX_PUSH_RETRIES=15
            PUSH_RETRY=0
            PUSH_SUCCESS=false
            
            while [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; do
              echo "üöÄ Push-Versuch $((PUSH_RETRY + 1))/$MAX_PUSH_RETRIES..."
              
              git fetch origin main 2>&1
              
              LOCAL=$(git rev-parse HEAD)
              REMOTE=$(git rev-parse origin/main)
              BASE=$(git merge-base HEAD origin/main)
              
              if [ "$REMOTE" != "$BASE" ]; then
                echo "‚ö†Ô∏è Remote ist voraus..."
                git rebase origin/main 2>&1 || git merge origin/main --no-edit 2>&1 || {
                  echo "üîÑ Reset und neu committen..."
                  git reset --hard origin/main 2>&1
                  git add aktuelle_teams_automatisch.txt
                  git commit -m "Update scraped data" 2>&1
                }
              fi
              
              # Push (letzten 2 Versuche mit --force-with-lease)
              if [ $PUSH_RETRY -ge $((MAX_PUSH_RETRIES - 2)) ]; then
                echo "‚ÑπÔ∏è Verwende --force-with-lease"
                PUSH_OUTPUT=$(git push origin HEAD:main --force-with-lease 2>&1)
              else
                PUSH_OUTPUT=$(git push origin HEAD:main 2>&1)
              fi
              PUSH_EXIT=$?
              
              if [ $PUSH_EXIT -eq 0 ]; then
                echo "‚úÖ Push erfolgreich!"
                PUSH_SUCCESS=true
                break
              else
                echo "$PUSH_OUTPUT"
                
                if echo "$PUSH_OUTPUT" | grep -q "rejected\|fetch first"; then
                  echo "‚ö†Ô∏è Push abgelehnt"
                  PUSH_RETRY=$((PUSH_RETRY + 1))
                  if [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; then
                    WAIT=$((PUSH_RETRY * 3))
                    echo "‚è≥ Warte ${WAIT}s..."
                    sleep $WAIT
                    
                    git fetch origin main 2>&1
                    git rebase origin/main 2>&1 || git merge origin/main --no-edit 2>&1 || {
                      echo "üîÑ Reset und neu committen..."
                      git reset --hard origin/main 2>&1
                      git add aktuelle_teams_automatisch.txt
                      git commit -m "Update scraped data" 2>&1
                    }
                  fi
                else
                  echo "‚ùå Anderer Fehler"
                  PUSH_RETRY=$((PUSH_RETRY + 1))
                  if [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; then
                    sleep $((PUSH_RETRY * 2))
                  fi
                fi
              fi
            done
            
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "‚ùå Push fehlgeschlagen"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è Keine √Ñnderungen"
          fi
