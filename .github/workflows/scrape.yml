name: Scrape and publish data

on:
  workflow_dispatch:  # manuelles Ausf√ºhren
  schedule:
    - cron: '0 2 * * *'  # t√§glich um 02:00 Uhr UTC (03:00 MEZ / 04:00 MESZ)

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Compile and run KaderScraper
        run: |
          javac *.java
          java KaderScraper

      - name: Commit and push results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # F√ºge √Ñnderungen hinzu
          git add *.txt
          
          # Pr√ºfe ob es √Ñnderungen gibt
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Keine √Ñnderungen zum Committen"
            exit 0
          fi
          
          # Commit
          git commit -m "Update scraped data" || {
            echo "‚ö†Ô∏è Commit fehlgeschlagen"
            exit 0
          }
          
          # Push mit Retry-Logik (verhindert Abbruch bei gleichzeitigen Commits)
          MAX_RETRIES=10
          RETRY=0
          SUCCESS=false
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            echo "üöÄ Push-Versuch $((RETRY + 1))/$MAX_RETRIES..."
            
            # Hole neueste √Ñnderungen vor Push
            git fetch origin main 2>&1
            
            # Pr√ºfe ob Remote voraus ist
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/main)
            BASE=$(git merge-base HEAD origin/main)
            
            if [ "$REMOTE" != "$BASE" ]; then
              echo "üì• Remote hat neue Commits - hole sie..."
              git pull --rebase origin main 2>&1 || {
                echo "‚ö†Ô∏è Rebase fehlgeschlagen - versuche Merge..."
                git rebase --abort 2>&1 || true
                git pull --no-rebase origin main 2>&1 || {
                  echo "‚ö†Ô∏è Merge fehlgeschlagen - Reset..."
                  git reset --hard origin/main 2>&1
                  git add *.txt
                  git commit -m "Update scraped data" 2>&1 || true
                }
              }
            fi
            
            # Versuche Push
            if git push origin main 2>&1; then
              echo "‚úÖ Push erfolgreich!"
              SUCCESS=true
              break
            else
              echo "‚ö†Ô∏è Push fehlgeschlagen - warte und versuche erneut..."
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                sleep $((RETRY * 3))
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "‚ùå Push fehlgeschlagen nach $MAX_RETRIES Versuchen"
            exit 1
          fi
